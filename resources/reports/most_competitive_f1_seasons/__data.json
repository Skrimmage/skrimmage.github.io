{"type":"data","nodes":[{"type":"data","data":[{"routeHash":1,"paramsHash":2,"customFormattingSettings":3,"isUserPage":6,"evidencemeta":7},"ce8a3d454da77193665e08c24d5847ed","d41d8cd98f00b204e9800998ecf8427e",{"version":4,"customFormats":5},"1.0",[],true,{"queries":8},[9],{"id":10,"compiledQueryString":11,"inputQueryString":11,"compiled":12,"inline":12},"competitive_seasons","WITH race_count\n     AS (SELECT Count(raceid) num_of_races,\n                Max(raceid)   max_race,\n                year\n         FROM   f1.races\n         GROUP  BY year),\n     race_and_year\n     AS (SELECT r.raceid,\n                year\n         FROM   f1.races r),\n     top_points\n     AS (SELECT ry.raceid,\n                Max(Cast(ds.points AS INT)) top_points\n         FROM   race_and_year ry,\n                f1.driver_standings ds\n         WHERE  ry.raceid = ds.raceid\n         GROUP  BY ry.raceid),\n     race_breakdowns\n     AS (SELECT ry.*,\n                Cast(ds.points AS INT)\n                   AS points,\n                Round(( Cast(ds.points AS FLOAT) / tp.top_points ) * 100, 1)\n                   AS percent_points,\n                ( Cast(max_race AS FLOAT) - Cast(ry.raceid AS\n                FLOAT) ) / rc.num_of_races\n                   AS\n                percent_race\n         FROM   race_and_year ry,\n                f1.driver_standings ds,\n                top_points tp,\n                race_count rc\n         WHERE  ry.raceid = ds.raceid\n                AND ry.raceid = tp.raceid\n                AND ry.year = rc.year),\n     close_driver_races\n     AS (SELECT raceid,\n                year,\n                Sum(CASE\n                      WHEN Cast(percent_points AS FLOAT) > 80 THEN 1\n                      ELSE 0\n                    END) - 1                    AS close_drivers_80,\n                Sum(CASE\n                      WHEN Cast(percent_points AS FLOAT) > 90 THEN 1\n                      ELSE 0\n                    END) - 1                    AS close_drivers_90,\n                Sum(CASE\n                      WHEN Cast(percent_points AS FLOAT) > 95 THEN 1\n                      ELSE 0\n                    END) - 1                    AS close_drivers_95,\n                percent_race * ( Sum(CASE\n                                       WHEN Cast(percent_points AS FLOAT) > 80\n                                     THEN 1\n                                       ELSE 0\n                                     END) - 1 ) AS weighted_close_drivers_80,\n                percent_race * ( Sum(CASE\n                                       WHEN Cast(percent_points AS FLOAT) > 90\n                                     THEN 1\n                                       ELSE 0\n                                     END) - 1 ) AS weighted_close_drivers_90,\n                percent_race * ( Sum(CASE\n                                       WHEN Cast(percent_points AS FLOAT) > 95\n                                     THEN 1\n                                       ELSE 0\n                                     END) - 1 ) AS weighted_close_drivers_95\n         FROM   race_breakdowns rb\n         GROUP  BY raceid, year, percent_race)\nSELECT Max(year) as year,\n       ( Sum(close_drivers_80)\n         + Sum(close_drivers_90)\n         + Sum(close_drivers_95) )             points,\n       Sum(close_drivers_95),\n       Sum(close_drivers_90),\n       Sum(close_drivers_80),\n       Round(Sum(weighted_close_drivers_95)\n             + Sum(weighted_close_drivers_90)\n             + Sum(weighted_close_drivers_80)) AS weighted_points,\n       Round(Sum(weighted_close_drivers_95)),\n       Round(Sum(weighted_close_drivers_90)),\n       Round(Sum(weighted_close_drivers_80))\nFROM   close_driver_races\nGROUP  BY year\nORDER  BY points DESC, weighted_points DESC",false],"uses":{"route":1},"slash":"always"},null]}
